# نظام إدارة الخصائص (Attributes System)

## نظرة عامة
نظام الخصائص هو نظام مرن ومتطور لإدارة خيارات التخصيص للمنتجات في المطعم. يسمح للمسؤولين بإنشاء خصائص قابلة لإعادة الاستخدام وربطها بمنتجات مختلفة.

---

## 🏗️ البنية الأساسية

### 1. جدول `attributes` (الخصائص الأساسية)
يحتوي على تعريف الخاصية نفسها:

```sql
CREATE TABLE attributes (
  id UUID PRIMARY KEY,
  name_ar TEXT NOT NULL,           -- اسم الخاصية بالعربية
  name_en TEXT NOT NULL,           -- اسم الخاصية بالإنجليزية
  description_ar TEXT,             -- وصف الخاصية بالعربية
  description_en TEXT,             -- وصف الخاصية بالإنجليزية
  attribute_type TEXT NOT NULL,    -- نوع الخاصية (serving_type, sauce, bread, etc.)
  is_required BOOLEAN DEFAULT false,  -- هل الخاصية إجبارية؟
  is_active BOOLEAN DEFAULT true,     -- هل الخاصية نشطة؟
  sort_order INTEGER DEFAULT 0,       -- ترتيب العرض
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**أمثلة على الخصائص:**
- نوع التقديم (Serving Type): عادي / عائلي / فردي
- نوع الصوص (Sauce Type): كاتشب / مايونيز / خردل
- نوع الخبز (Bread Type): أبيض / أسمر / بالسمسم
- درجة الحرارة (Temperature): ساخن / بارد / دافئ

---

### 2. جدول `attribute_options` (خيارات الخصائص)
يحتوي على الخيارات المتاحة لكل خاصية:

```sql
CREATE TABLE attribute_options (
  id UUID PRIMARY KEY,
  attribute_id UUID NOT NULL REFERENCES attributes(id),
  name_ar TEXT NOT NULL,           -- اسم الخيار بالعربية
  name_en TEXT NOT NULL,           -- اسم الخيار بالإنجليزية
  price_adjustment NUMERIC DEFAULT 0,  -- التعديل على السعر (+5 أو -3 مثلاً)
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**مثال:**
للخاصية "نوع التقديم":
- عادي (سعر عادي: 0)
- عائلي (+15 جنيه)
- فردي (-5 جنيه)

---

### 3. جدول `menu_item_attributes` (ربط المنتجات بالخصائص)
يربط المنتجات بالخصائص المتاحة لها:

```sql
CREATE TABLE menu_item_attributes (
  id UUID PRIMARY KEY,
  menu_item_id UUID NOT NULL REFERENCES menu_items(id),
  attribute_id UUID NOT NULL REFERENCES attributes(id),
  is_required_for_item BOOLEAN DEFAULT false,  -- هل الخاصية إجبارية لهذا المنتج؟
  created_at TIMESTAMP
);
```

---

### 4. جدول `attribute_dependencies` (التبعيات بين الخيارات)
يسمح بإنشاء علاقات تبعية بين الخيارات (ميزة متقدمة):

```sql
CREATE TABLE attribute_dependencies (
  id UUID PRIMARY KEY,
  parent_option_id UUID NOT NULL REFERENCES attribute_options(id),
  child_attribute_id UUID NOT NULL REFERENCES attributes(id),
  created_at TIMESTAMP
);
```

**مثال على التبعية:**
- إذا اختار العميل "عائلي" في نوع التقديم
- يظهر تلقائياً خاصية "عدد الصحون" (4 / 6 / 8)

---

## 📋 كيفية الاستخدام

### 1️⃣ إنشاء خاصية جديدة
من صفحة "إدارة الخصائص" (`/admin/attributes`):

1. اضغط على "Add Attribute"
2. املأ المعلومات:
   - الاسم بالعربية والإنجليزية
   - نوع الخاصية (attribute_type)
   - الوصف (اختياري)
   - هل هي إجبارية بشكل افتراضي؟
3. اضغط "Add"

---

### 2️⃣ إضافة خيارات للخاصية
بعد إنشاء الخاصية:

1. اضغط على "Add Option" بجانب الخاصية
2. املأ معلومات الخيار:
   - الاسم بالعربية والإنجليزية
   - تعديل السعر (اختياري)
   - ترتيب العرض
3. اضغط "Add"

**مثال:**
خاصية: نوع الصوص
- كاتشب (+0 جنيه)
- مايونيز (+2 جنيه)
- خردل (+1 جنيه)
- صوص خاص (+5 جنيه)

---

### 3️⃣ ربط الخصائص بالمنتجات
من صفحة "إدارة المنتجات" (`/admin/products`):

1. عند إضافة أو تعديل منتج
2. حدد الخصائص المتاحة لهذا المنتج
3. حدد أي منها إجبارية لهذا المنتج بالذات

---

## 🎯 حالات الاستخدام

### حالة 1: ساندويتش شاورما
**الخصائص:**
- نوع الخبز (إجبارية): أبيض / أسمر / خبز تورتيلا
- نوع الصوص (إجبارية): ثوم / طحينة / حار
- إضافات (اختيارية): بطاطس (+5 جنيه) / جبن (+7 جنيه) / خضار إضافي (+3 جنيه)

### حالة 2: بيتزا
**الخصائص:**
- الحجم (إجبارية): صغير / وسط / كبير / عائلي
- سمك العجينة (إجبارية): رفيع / سميك / محشي
- إضافات (اختيارية): جبن إضافي (+10 جنيه) / زيتون (+5 جنيه) / فلفل حار (مجاني)

### حالة 3: مشروب
**الخصائص:**
- الحجم (إجبارية): صغير / وسط / كبير
- درجة الحرارة (إجبارية): بارد / مثلج / دافئ
- إضافات (اختيارية): سكر (+0) / بدون سكر (+0) / سكر دايت (+2 جنيه)

---

## 🔄 التدفق الكامل

```
1. المسؤول ينشئ خاصية "نوع التقديم"
   ↓
2. يضيف خيارات: عادي / عائلي / فردي
   ↓
3. يربط هذه الخاصية بمنتج "برجر الدجاج"
   ↓
4. يحدد أن هذه الخاصية إجبارية
   ↓
5. العميل يطلب "برجر الدجاج"
   ↓
6. يظهر له اختيار "نوع التقديم"
   ↓
7. يختار "عائلي" (السعر يزيد بمقدار +15 جنيه)
   ↓
8. يُضاف المنتج للسلة بالسعر المعدّل
```

---

## ✨ المميزات الرئيسية

### 1. المرونة الكاملة
- يمكن إنشاء أي نوع من الخصائص
- ليس هناك قيود على عدد الخصائص أو الخيارات
- يمكن استخدام نفس الخاصية لمنتجات مختلفة

### 2. إدارة الأسعار الذكية
- تحديد تأثير كل خيار على السعر النهائي
- يمكن زيادة أو تقليل السعر
- حساب تلقائي للسعر الإجمالي

### 3. تعدد اللغات
- دعم كامل للعربية والإنجليزية
- جميع الخصائص والخيارات متعددة اللغات

### 4. التبعيات المتقدمة
- إمكانية إظهار خصائص بناءً على خيارات أخرى
- مثال: عند اختيار "حجم عائلي" تظهر "عدد الصحون"

---

## 🛠️ إدارة الخصائص

### تفعيل/تعطيل
- يمكن تعطيل أي خاصية مؤقتاً دون حذفها
- الخصائص المعطلة لا تظهر للعملاء

### الترتيب
- يمكن التحكم في ترتيب ظهور الخصائص
- يمكن التحكم في ترتيب الخيارات داخل كل خاصية

### التعديل والحذف
- يمكن تعديل أي خاصية أو خيار في أي وقت
- حذف الخاصية سيحذف جميع خياراتها

---

## 📊 قاعدة البيانات - العلاقات

```
attributes (الخصائص)
    ↓ has many
attribute_options (الخيارات)
    ↓
menu_item_attributes (الربط)
    ↓ links
menu_items (المنتجات)
```

---

## 🎨 واجهة المستخدم

### للمسؤول (Admin Panel)
- صفحة مخصصة لإدارة الخصائص (`/admin/attributes`)
- واجهة بسيطة لإضافة وتعديل الخصائص
- عرض جميع الخصائص مع خياراتها

### للعميل (Customer View)
- عند اختيار منتج، تظهر الخصائص المتاحة
- واجهة تفاعلية لاختيار الخيارات
- عرض تلقائي للسعر المعدّل

---

## 🔒 ملاحظات الأمان

- جميع الجداول محمية بـ RLS (Row Level Security)
- التعديلات متاحة للمسؤولين فقط
- القراءة متاحة للجميع

---

## 📝 أمثلة على الاستعلامات

### جلب خصائص منتج معين:
```sql
SELECT 
  a.name_ar, 
  a.name_en,
  ao.name_ar as option_ar,
  ao.name_en as option_en,
  ao.price_adjustment
FROM menu_item_attributes mia
JOIN attributes a ON mia.attribute_id = a.id
JOIN attribute_options ao ON ao.attribute_id = a.id
WHERE mia.menu_item_id = 'product-id-here'
  AND a.is_active = true
  AND ao.is_active = true
ORDER BY a.sort_order, ao.sort_order;
```

---

## 🚀 الخطوات التالية للتطوير

1. ✅ إنشاء الجداول الأساسية
2. ✅ بناء واجهة الإدارة
3. ⏳ ربط الخصائص بالمنتجات في الكود
4. ⏳ عرض الخصائص للعملاء
5. ⏳ حساب الأسعار تلقائياً
6. ⏳ دعم التبعيات المتقدمة

---

## 💡 نصائح للاستخدام الأمثل

1. **التسمية الواضحة**: استخدم أسماء واضحة ومعبرة للخصائص
2. **التنظيم**: استخدم `attribute_type` لتجميع الخصائص المتشابهة
3. **الترتيب المنطقي**: رتب الخصائص حسب أهميتها
4. **الأسعار الدقيقة**: تأكد من دقة تعديلات الأسعار
5. **الاختبار**: اختبر الخصائص قبل تفعيلها للعملاء

---

## 🆘 حل المشاكل الشائعة

### المشكلة: الخاصية لا تظهر للعميل
**الحل:** تأكد من:
- الخاصية مفعّلة (`is_active = true`)
- الخاصية مربوطة بالمنتج في `menu_item_attributes`
- الخيارات المتاحة مفعّلة

### المشكلة: السعر لا يتحدث بشكل صحيح
**الحل:** تحقق من:
- `price_adjustment` في جدول `attribute_options`
- الكود يحسب السعر الإجمالي بشكل صحيح

---

## 📞 الدعم الفني

إذا كان لديك أي استفسارات أو تحتاج مساعدة في استخدام النظام، يمكنك:
- مراجعة هذا الدليل
- فحص الكود في `src/pages/admin/AttributeManagement.tsx`
- مراجعة الـ hooks في `src/hooks/useDynamicAttributes.ts`

---

**آخر تحديث:** 2025-10-01
**الإصدار:** 1.0
